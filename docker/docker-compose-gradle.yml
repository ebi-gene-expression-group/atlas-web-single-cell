version: "3.6"

services:
  scxa-gradle:
    image: openjdk:11
    container_name: scxa-gradle
    networks:
      - atlas-test-net
    ports:
      - "5005:5005"
    working_dir: /root/project
    volumes:
      - ..:/root/project
      - gradle-wrapper-dists:/root/.gradle/wrapper/dists
      - gradle-ro-dep-cache:/gradle-ro-dep-cache:ro
      - bioentity-properties:/atlas-data/bioentity_properties:ro
      - scxa-data:/atlas-data/scxa:ro
      - scxa-expdesign:/atlas-data/expdesign

    depends_on:
      - scxa-solrcloud-0
      - scxa-solrcloud-1
      - scxa-flyway-test
    environment:
      POSTGRES_HOST: $POSTGRES_HOST
      POSTGRES_DB: $POSTGRES_DB
      POSTGRES_USER: $POSTGRES_USER
      POSTGRES_PASSWORD: $POSTGRES_PASSWORD
      GRADLE_RO_DEP_CACHE: /gradle-ro-dep-cache
    command:
      - sh
      - -c
      - >
        ./gradlew :app:clean &&
        ./gradlew
        -PdataFilesLocation=/atlas-data
        -PexperimentFilesLocation=/atlas-data/scxa
        -PexperimentDesignLocation=/atlas-data/expdesign
        -PjdbcUrl=jdbc:postgresql://$POSTGRES_HOST:5432/$POSTGRES_DB
        -PjdbcUsername=$POSTGRES_USER
        -PjdbcPassword=$POSTGRES_PASSWORD
        -PzkHosts=${SOLR_CLOUD_ZK_CONTAINER_1_NAME}:2181,${SOLR_CLOUD_ZK_CONTAINER_2_NAME}:2181,${SOLR_CLOUD_ZK_CONTAINER_3_NAME}:2181
        -PsolrHosts=http://${SOLR_CLOUD_CONTAINER_1_NAME}:8983/solr,http://${SOLR_CLOUD_CONTAINER_2_NAME}:8983/solr
        :app:testClasses &&
        ./gradlew -PtestResultsPath=ut :app:test --tests *Test &&
        ./gradlew -PtestResultsPath=it -PexcludeTests=**/*WIT.class :app:test --tests *IT &&
        ./gradlew -PtestResultsPath=e2e :app:test --tests *WIT &&
        ./gradlew :app:jacocoTestReport

volumes:
  gradle-wrapper-dists:
    name: ${GRADLE_WRAPPER_DISTS_VOL_NAME}
  gradle-ro-dep-cache:
    name: ${GRADLE_RO_DEP_CACHE_VOL_NAME}
  bioentity-properties:
    name: ${ATLAS_DATA_BIOENTITY_PROPERTIES_VOL_NAME}
  scxa-data:
    name: ${ATLAS_DATA_SCXA_VOL_NAME}
  scxa-expdesign:
    name: ${ATLAS_DATA_SCXA_EXPDESIGN_VOL_NAME}

networks:
  atlas-test-net:
    name: atlas-test-net
