version: "3.6"

services:
  scxa-gradle:
    image: openjdk:11
    container_name: scxa-gradle
    networks:
      - scxa
    working_dir: /root/project
    volumes:
      - $PWD:/root/project
      - $ATLAS_MAVEN_CACHE:/root/.m2
      - $ATLAS_GRADLE_CACHE:/root/.gradle
      - $ATLAS_DATA_PATH/filesystem:/root/scxa/integration-test-data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - scxa-solrcloud-1
      - scxa-solrcloud-2
      - scxa-postgres
    command:
      - /bin/bash
      - -c
      - >
        ./gradlew \
          -PdataFilesLocation=/root/scxa/integration-test-data \
          -PexperimentFilesLocation=/root/scxa/integration-test-data/scxa \
          -PjdbcUrl=jdbc:postgresql://localhost:5432/$POSTGRES_DB \
          -PjdbcUsername=$POSTGRES_USER \
          -PjdbcPassword=$POSTGRES_PASSWORD \
          -PzkHost=scxa-zk-1 \
          -PsolrHost=scxa-solrcloud-1 \
          :app:clean :app:testClasses && \
        ./gradlew :app:test --tests *Test && \
        ./gradlew -PtestResultsPath=it -PexcludeTests=**/*WIT.class :app:test --tests *IT && \
        ./gradlew -PtestResultsPath=e2e :app:test --tests *WIT

networks:
  scxa:
    name: scxa